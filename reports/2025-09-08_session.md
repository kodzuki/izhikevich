# Informe de análisis de conectividad (sesión del notebook)

## 1) Contexto y datos

* **Formato**: diccionario `data[(i,j)] → matriz n×6` por par de ROIs. Columnas usadas: `τ(s), D(m), V(m/s)`; el resto (`AX, FM, FR`) no se analizó aquí.
* **Atlas/índices**: 78 ROIs por hemisferio → **156** índices (L: 0–77, R: 78–155). Se detectó una cabecera residual (“`roi_name`”) en el archivo de nombres y se **corrigió** para alinear índices.
* **Cobertura observada** (archivo th-0.4): **3937/12090** pares posibles (no dirigidos) ⇒ **densidad 0.326**.
* **Umbral de fibras**: trabajamos con conteos de fibras por par; punto de codo recomendado **t = 50** (≈20–30% de pares retenidos). A t=50 se obtuvo: **914 pares (23.2%)** y **134/156 ROIs** con ≥1 conexión retenida.

---

## 2) Pipeline que quedó establecido

### 2.1 Exploración rápida de pares (función `plot_pairs_2x2`)

* **Histogramas** (x-log) y **boxplot** (log10) de `n_fibers`.
* **Barra ≥t vs \<t** apilada por **intra/inter-hemisferio**.
* **Curva de cobertura** al barrer t ∈ {10, 30, 50, 100, 200}:

  * % de **pares** retenidos (principal) y % de **ROIs** cubiertos (secundaria).
    → Confirma **t=50** como compromiso razonable.

### 2.2 Limpieza mínima y robusta (`clean_data`)

* Reglas: finitos, positividad física (τ,D,V>0), **filtro de cuantiles de τ por par** (0.5–99.5‰ por defecto), y **umbral de n\_fibers**.
* **No** se impuso chequeo `τ≈D/V` (dejado opcional y **desactivado** por decisión analítica).

### 2.3 Matrices de conectividad (funciones `build_conn_mats` + `plot_conn_overview`)

* Construcción de matrices **simetrizadas** (media con NaN-aware; diagonal en NaN).
* **Misma máscara** para todas las vistas (τ, D, V) según `N≥t`.
* **Orden L/R** y líneas guía (separación 78/79).
* Paneles: τ(ms), D(mm), V(m/s), **N** con contorno del umbral, cobertura por ROI y **scatter τ–D** coloreado por `log10(N)`.

### 2.4 Comparativa clean vs raw

* **Panel 1×2**: columna izquierda (τ clean + scatter) y derecha (τ raw con límites coordinados).
* **Mapa de “lo eliminado”** en N: calor de `% de fibras retiradas` y **curva de cobertura por ROI** antes/después.

### 2.5 Variabilidad de τ por conexión

* Cálculo por par (≥10 mediciones): **n=1613** conexiones evaluadas;
  **CV medio (robusto)** de τ: **0.384**; **muy variables (CV>0.5)**: **405**.
* **Top consistentes** (CV bajo), p.ej.: `11–46 (0.516 ms, CV=0.001)`, `45–105 (2.105 ms, CV=0.001)`.
* **Top variables** (CV alto), p.ej.: `46–49 (0.112 ms, CV=4.63)`, `45–49 (0.030 ms, CV=2.34, n=734)`.

### 2.6 Relación global τ≈D/v (datos limpios)

* **n=324,712** muestras; **r=0.896 (R²=0.802)**.
* **Pendiente**: **0.1704 ms/mm** ⇒ **velocidad estimada** **v̂ ≈ 5.87 m/s**.
* **Intercepto**: **b=0.017 ms**.
* **Residuos**: mediana ≈ **−0.001 ms**, **MAD=0.092 ms**, p5=−0.232, p95=0.492.
  → Consistencia clara con un **régimen de conducción** estable y sesgo temporal mínimo.

### 2.7 ROIs y pares “ricos” (para muestrear distribuciones de τ)

* **Ranking ROI** (ejemplos):
  roi 97 (degree=14, 3115 fibras, **score alto** por baja variabilidad),
  roi 137 (degree=20, 6309 fibras), roi 54 (degree=16, 3981).
* **Pares destacados** (con nombres, tras mapear L/R):

  * **Inter**: *L-Cingulate area 1 ↔ R-Primary motor area* — **n=58**, **τ\_med=0.79 ms**, **CV\_rob=0.0034**.
  * **Intra**: *L-Primary somatosensory ↔ L-Primary visual* — **n=1191**, **τ\_med=0.97 ms**, **CV\_rob=0.0769**.
  * Otros intra consistentes: *R-Perirhinal area 35 ↔ R-Primary auditory area* (n=148, τ\_med=0.053 ms, CV\_rob=0.0081).

### 2.8 Herramientas para inspección puntual (conexión única / varias / cluster coherente)

* **`analyze_single_connection`**: hist de τ(ms) + **scatter τ–D** con color por V, y métricas robustas (mediana, p10/p90, CV\_rob).
* **`compare_connections`**: hist de τ de **k** conexiones (p.ej. las de mayor **n**).
* **`extract_coherent_cluster`**: DBSCAN en z-scores de \[τ(ms), D(mm), V] (o en residuo **|τ−D/v̂|**) para aislar el **subconjunto más homogéneo** dentro de una conexión.

---

## 3) Hallazgos principales

* La red (th-0.4) es **moderadamente densa** (0.326) y, con **t=50**, conserva \~**¼ de los pares** y **\~86% de ROIs** conectados — buen compromiso señal/ cobertura.
* **Relación física τ–D** muy marcada (R²≈0.80) con **v̂≈5.9 m/s** y **sesgo temporal despreciable**; residuos estrechos (MAD≈0.09 ms).
* Existe **heterogeneidad por conexión**: un núcleo de pares muy **consistentes** (CV\_rob bajo) y un subconjunto **muy variable** (CV>0.5) que conviene tratar con cautela o **clusterizar**.
* Identificamos **ROIs/padres “ricos”** (alto grado y/o muchas fibras) que son **buenos candidatos** para muestrear distribuciones de τ y para figuras demostrativas (incluyendo ejemplos intra/inter hemisféricos).

---

## 4) Recomendaciones prácticas

1. **Usar t=50** como umbral por defecto en este conjunto; ajustar según objetivo (más cobertura vs más fiabilidad).
2. **Muestreo de casos**: elegir pares con **n alto** y **CV\_rob bajo** para análisis de τ representativos; reportar también algunos **inter** para contraste anatómico.
3. **Cluster interno** en pares variables: aplicar `extract_coherent_cluster` para separar subpoblaciones y **mejorar estimaciones** (mediana τ, etc.).
4. **Atlas**: consolidar el **mapa de nombres** (ya corregida la cabecera) y mantener la **convención L/R** (0–77, 78–155) en todas las figuras.
5. **Comparativa**: repetir todos los paneles con el archivo **no filtrado** (th-0.0) para **cuantificar el efecto del filtrado** (densidad, cobertura, v̂, residuos).

---

## 5) Entregables funcionales (lista breve)

* **Exploración de pares**: `plot_pairs_2x2(...)`.
* **Limpieza**: `clean_data(...)` (mínima, cuantiles de τ por par; sin τ≈D/V).
* **Construcción/visualización de matrices**: `build_conn_mats(...)`, `plot_conn_overview(...)`, `plot_conn_panel_1x2(...)`, `plot_removed_counts(...)`.
* **Variabilidad por conexión**: `compute_tau_stats(...)`, `plot_tau_variability(...)`.
* **Relación τ–D global**: función de análisis robusto (Theil–Sen o lineal con *downsample*) y panel de residuos.
* **Selección e inspección de pares “ricos”**: `analyze_single_connection(...)`, `compare_connections(...)`, `extract_coherent_cluster(...)`.

---

## 6) Conclusión

El cuaderno queda con un **flujo reproducible y coherente**: limpieza ligera y robusta, **máscaras consistentes**, **matrices simetrizadas** y orden L/R, métricas de **cobertura/variabilidad**, y un **análisis físico de τ≈D/v** que estabiliza alrededor de **\~5.9 m/s** con residuos estrechos. Con esto, ya podemos **resumir la red**, **elegir pares ejemplares** y montar comparativas **clean vs raw** y **intra vs inter** con fundamento.
